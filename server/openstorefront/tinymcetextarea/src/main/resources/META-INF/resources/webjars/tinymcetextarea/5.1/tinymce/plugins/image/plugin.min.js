
tinymce.PluginManager.add("image",function(e){function c(h,j){var g=document.createElement("img");function f(l,k){if(g.parentNode){g.parentNode.removeChild(g)}j({width:l,height:k})}g.onload=function(){f(g.clientWidth,g.clientHeight)};g.onerror=function(){f()};var i=g.style;i.visibility="hidden";i.position="fixed";i.bottom=i.left=0;i.width=i.height="auto";document.body.appendChild(g);g.src=h}function d(h,f,i){function g(k,j){j=j||[];tinymce.each(k,function(m){var l={text:m.text||m.title};if(m.menu){l.menu=g(m.menu)}else{l.value=m.value;f(l)}j.push(l)});return j}return g(h,i||[])}function b(f){return function(){var g=e.settings.image_list;if(typeof(g)=="string"){tinymce.util.XHR.send({url:g,success:function(h){f(tinymce.util.JSON.parse(h))}})}else{if(typeof(g)=="function"){g(f)}else{f(g)}}}}function a(i){var o,m={},l=e.dom,p=e.selection.getNode();var g,s,q,f,n=e.settings.image_dimensions!==false;function j(){var w,y,x,v;w=o.find("#width")[0];y=o.find("#height")[0];if(!w||!y){return}x=w.value();v=y.value();if(o.find("#constrain")[0].checked()&&g&&s&&x&&v){if(g!=x){v=Math.round((x/g)*v);y.value(v)}else{x=Math.round((v/s)*x);w.value(x)}}g=x;s=v}function k(){function v(x){function w(){x.onload=x.onerror=null;if(e.selection){e.selection.select(x);e.nodeChanged()}}x.onload=function(){if(!m.width&&!m.height&&n){l.setAttribs(x,{width:x.clientWidth,height:x.clientHeight})}w()};x.onerror=w}t();j();m=tinymce.extend(m,o.toJSON());if(!m.alt){m.alt=""}if(m.width===""){m.width=null}if(m.height===""){m.height=null}if(!m.style){m.style=null}m={src:m.src,alt:m.alt,width:m.width,height:m.height,style:m.style,"class":m["class"]};e.undoManager.transact(function(){if(!m.src){if(p){l.remove(p);e.focus();e.nodeChanged()}return}if(!p){m.id="__mcenew";e.focus();e.selection.setContent(l.createHTML("img",m));p=l.get("__mcenew");l.setAttrib(p,"id",null)}else{l.setAttribs(p,m)}v(p)})}function u(v){if(v){v=v.replace(/px$/,"")}return v}function r(w){var v=w.meta||{};if(q){q.value(e.convertURL(this.value(),"src"))}tinymce.each(v,function(y,x){o.find("#"+x).value(y)});if(!v.width&&!v.height){c(this.value(),function(x){if(x.width&&x.height&&n){g=x.width;s=x.height;o.find("#width").value(g);o.find("#height").value(s)}})}}g=l.getAttrib(p,"width");s=l.getAttrib(p,"height");if(p.nodeName=="IMG"&&!p.getAttribute("data-mce-object")&&!p.getAttribute("data-mce-placeholder")){m={src:l.getAttrib(p,"src"),alt:l.getAttrib(p,"alt"),"class":l.getAttrib(p,"class"),width:g,height:s}}else{p=null}if(i){q={type:"listbox",label:"Image list",values:d(i,function(v){v.value=e.convertURL(v.value||v.url,"src")},[{text:"None",value:""}]),value:m.src&&e.convertURL(m.src,"src"),onselect:function(v){var w=o.find("#alt");if(!w.value()||(v.lastControl&&w.value()==v.lastControl.text())){w.value(v.control.text())}o.find("#src").value(v.control.value()).fire("change")},onPostRender:function(){q=this}}}if(e.settings.image_class_list){f={name:"class",type:"listbox",label:"Class",values:d(e.settings.image_class_list,function(v){if(v.value){v.textStyle=function(){return e.formatter.getCssText({inline:"img",classes:[v.value]})}}})}}var h=[{type:"panel",html:'<div style="background: white;">It is preferable to add <span style="font-weight: bold;">Images</span> to an entry using <span style="font-weight: bold;">Details->Media</span> form.<br>This will embed the image in the description.</div>'},{name:"src",type:"filepicker",filetype:"image",label:"Source URL",placeholder:"http://media.com/image.png",autofocus:true,onchange:r},q];if(e.settings.image_description!==false){h.push({name:"alt",type:"textbox",label:"Image description"})}if(n){h.push({type:"container",label:"Dimensions",layout:"flex",direction:"row",align:"center",spacing:5,items:[{name:"width",type:"textbox",maxLength:5,size:3,onchange:j,ariaLabel:"Width"},{type:"label",text:"x"},{name:"height",type:"textbox",maxLength:5,size:3,onchange:j,ariaLabel:"Height"},{name:"constrain",type:"checkbox",checked:true,text:"Constrain proportions"}]})}h.push(f);function t(){function x(y){if(y.length>0&&/^[0-9]+$/.test(y)){y+="px"}return y}if(!e.settings.image_advtab){return}var w=o.toJSON();var v=l.parseStyle(w.style);delete v.margin;v["margin-top"]=v["margin-bottom"]=x(w.vspace);v["margin-left"]=v["margin-right"]=x(w.hspace);v["border-width"]=x(w.border);o.find("#style").value(l.serializeStyle(l.parseStyle(l.serializeStyle(v))))}if(e.settings.image_advtab){if(p){m.hspace=u(p.style.marginLeft||p.style.marginRight);m.vspace=u(p.style.marginTop||p.style.marginBottom);m.border=u(p.style.borderWidth);m.style=e.dom.serializeStyle(e.dom.parseStyle(e.dom.getAttrib(p,"style")))}o=e.windowManager.open({title:"Insert/edit image",data:m,bodyType:"tabpanel",body:[{title:"General",type:"form",items:h},{title:"Advanced",type:"form",pack:"start",items:[{label:"Style",name:"style",type:"textbox"},{type:"form",layout:"grid",packV:"start",columns:2,padding:0,alignH:["left","right"],defaults:{type:"textbox",maxWidth:50,onchange:t},items:[{label:"Vertical space",name:"vspace"},{label:"Horizontal space",name:"hspace"},{label:"Border",name:"border"}]}]}],onSubmit:k})}else{o=e.windowManager.open({title:"Insert/edit image",data:m,body:h,onSubmit:k})}}e.addButton("image",{icon:"image",tooltip:"Insert/edit image",onclick:b(a),stateSelector:"img:not([data-mce-object],[data-mce-placeholder])"});e.addMenuItem("image",{icon:"image",text:"Insert image",onclick:b(a),context:"insert",prependToContext:true});e.addCommand("mceImage",b(a))});